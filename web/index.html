<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL Replication Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .status-healthy { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-critical { color: #ef4444; }
        .badge-healthy { background-color: #d1fae5; color: #065f46; }
        .badge-warning { background-color: #fef3c7; color: #92400e; }
        .badge-critical { background-color: #fee2e2; color: #991b1b; }
        .badge-active { background-color: #dbeafe; color: #1e40af; }
        .badge-inactive { background-color: #f3f4f6; color: #6b7280; }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Fixed header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: white;
        }
        /* Compact table styling */
        .compact-table {
            font-size: 0.875rem;
            table-layout: fixed;
            width: 100%;
        }
        .compact-table th {
            padding: 0.5rem;
            font-weight: 600;
            text-align: left;
            background-color: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }
        .compact-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .compact-table tr:hover {
            background-color: #f9fafb;
        }
        /* Fixed column widths to prevent shifting */
        .compact-table th:nth-child(1), .compact-table td:nth-child(1) { width: 20%; }
        .compact-table th:nth-child(2), .compact-table td:nth-child(2) { width: 8%; }
        .compact-table th:nth-child(3), .compact-table td:nth-child(3) { width: 10%; }
        .compact-table th:nth-child(4), .compact-table td:nth-child(4) { width: 12%; }
        .compact-table th:nth-child(5), .compact-table td:nth-child(5) { width: 8%; }
        .compact-table th:nth-child(6), .compact-table td:nth-child(6) { width: 10%; }
        .compact-table th:nth-child(7), .compact-table td:nth-child(7) { width: 10%; }
        .compact-table th:nth-child(8), .compact-table td:nth-child(8) { width: 8%; }
        .compact-table th:nth-child(9), .compact-table td:nth-child(9) { width: 14%; }
        /* Prevent layout shift on updates */
        .no-shift {
            min-height: 100vh;
        }
        /* Clickable rows */
        .compact-table tbody tr {
            cursor: pointer;
        }
        .detail-row {
            background-color: #f9fafb;
        }
        .detail-content {
            padding: 1rem;
            background-color: white;
            border-left: 3px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Fixed Header -->
    <header class="sticky-header bg-white shadow-sm border-b border-gray-200">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <i data-lucide="database" class="w-6 h-6 text-blue-600"></i>
                    <h1 class="text-xl font-bold text-gray-900">PostgreSQL Replication Monitor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full bg-gray-400"></div>
                        <span class="text-sm text-gray-600">Connecting...</span>
                    </div>
                    <div id="last-update" class="text-xs text-gray-500"></div>
                </div>
            </div>
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-5 gap-4 mb-3">
                <div class="bg-blue-50 rounded px-3 py-2">
                    <div class="text-xs text-blue-600 font-medium">Publications</div>
                    <div id="stat-pubs" class="text-lg font-bold text-blue-900">-</div>
                </div>
                <div class="bg-purple-50 rounded px-3 py-2">
                    <div class="text-xs text-purple-600 font-medium">Subscriptions</div>
                    <div id="stat-subs" class="text-lg font-bold text-purple-900">-</div>
                </div>
                <div class="bg-green-50 rounded px-3 py-2">
                    <div class="text-xs text-green-600 font-medium">Active Slots</div>
                    <div id="stat-slots" class="text-lg font-bold text-green-900">-</div>
                </div>
                <div class="bg-orange-50 rounded px-3 py-2">
                    <div class="text-xs text-orange-600 font-medium">Max Lag</div>
                    <div id="stat-lag" class="text-lg font-bold text-orange-900">-</div>
                </div>
                <div class="bg-gray-50 rounded px-3 py-2">
                    <div class="text-xs text-gray-600 font-medium">Health</div>
                    <div id="stat-health" class="text-lg font-bold text-gray-900">-</div>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div class="flex items-center space-x-3">
                <input type="text" id="search-box" placeholder="Search databases..." 
                    class="flex-1 px-3 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="filter-role" class="px-3 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Roles</option>
                    <option value="source">Source Only</option>
                    <option value="target">Target Only</option>
                </select>
                <select id="filter-status" class="px-3 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Status</option>
                    <option value="connected">Connected</option>
                    <option value="disconnected">Disconnected</option>
                    <option value="issues">With Issues</option>
                </select>
            </div>
        </div>
    </header>

    <!-- Main Content - Compact Table -->
    <main class="px-4 py-4">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="compact-table">
                <thead>
                    <tr>
                        <th>Database</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Current LSN</th>
                        <th>Pubs/Subs</th>
                        <th>Slots</th>
                        <th>LSN Distance</th>
                        <th>Lag (sec)</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="database-table-body">
                    <tr>
                        <td colspan="9" class="text-center py-8 text-gray-500">
                            <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                            <div>Loading databases...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Issues Panel -->
        <div id="issues-panel" class="mt-4 hidden">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-yellow-800 mb-2 flex items-center">
                    <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>
                    Active Issues
                </h3>
                <ul id="issues-list" class="text-sm text-yellow-700 space-y-1"></ul>
            </div>
        </div>
    </main>

    <script>
        let ws;
        let reconnectInterval;
        let allDatabases = [];
        let currentScrollPosition = 0;
        let expandedRows = new Set(); // Track which rows are expanded

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = (event) => {
                // Save scroll position before update
                currentScrollPosition = window.scrollY;
                
                const data = JSON.parse(event.data);
                updateDashboard(data);
                
                // Restore scroll position after update
                window.scrollTo(0, currentScrollPosition);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(() => {
                        console.log('Attempting to reconnect...');
                        connectWebSocket();
                    }, 5000);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-500 pulse-dot"></div>
                    <span class="text-sm text-green-600 font-medium">Connected</span>
                `;
            } else {
                statusEl.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span class="text-sm text-red-600 font-medium">Disconnected</span>
                `;
            }
        }

        function updateDashboard(snapshot) {
            allDatabases = snapshot.databases;
            updateLastUpdate(snapshot.timestamp);
            updateSummaryStats(snapshot.summary);
            updateIssues(snapshot.summary);
            
            // Only re-render table if data actually changed
            const currentData = JSON.stringify(allDatabases);
            if (currentData !== window.lastDatabaseData) {
                renderDatabaseTable();
                window.lastDatabaseData = currentData;
                // Only recreate icons after table changes
                setTimeout(() => lucide.createIcons(), 10);
            }
        }

        function updateLastUpdate(timestamp) {
            const date = new Date(timestamp);
            const formatted = date.toLocaleTimeString();
            document.getElementById('last-update').textContent = formatted;
        }

        function updateSummaryStats(summary) {
            document.getElementById('stat-pubs').textContent = summary.total_publications;
            document.getElementById('stat-subs').textContent = summary.total_subscriptions;
            document.getElementById('stat-slots').textContent = `${summary.active_slots}/${summary.total_slots}`;
            document.getElementById('stat-lag').textContent = formatBytes(summary.max_lag_bytes);
            
            const healthEl = document.getElementById('stat-health');
            healthEl.textContent = summary.health_status.toUpperCase();
            healthEl.className = `text-lg font-bold status-${summary.health_status}`;
        }

        function updateIssues(summary) {
            const panel = document.getElementById('issues-panel');
            const list = document.getElementById('issues-list');
            
            if (summary.issues && summary.issues.length > 0) {
                panel.classList.remove('hidden');
                list.innerHTML = summary.issues.map(issue => 
                    `<li>â€¢ ${issue}</li>`
                ).join('');
            } else {
                panel.classList.add('hidden');
            }
        }

        function updateSummary(summary) {
            const summarySection = document.getElementById('summary-section');
            summarySection.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Publications</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2">${summary.total_publications}</p>
                        </div>
                        <i data-lucide="book-open" class="w-12 h-12 text-blue-500 opacity-20"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Subscriptions</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2">${summary.total_subscriptions}</p>
                        </div>
                        <i data-lucide="rss" class="w-12 h-12 text-purple-500 opacity-20"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Replication Slots</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2">${summary.active_slots}/${summary.total_slots}</p>
                            <p class="text-xs text-gray-500 mt-1">Active / Total</p>
                        </div>
                        <i data-lucide="activity" class="w-12 h-12 text-green-500 opacity-20"></i>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Max Lag</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2">${formatBytes(summary.max_lag_bytes)}</p>
                            ${summary.max_lag_seconds > 0 ? `<p class="text-xs text-gray-500 mt-1">${summary.max_lag_seconds.toFixed(2)}s</p>` : ''}
                        </div>
                        <i data-lucide="gauge" class="w-12 h-12 text-orange-500 opacity-20"></i>
                    </div>
                </div>
            `;
        }

        function updateHealthStatus(summary) {
            const healthSection = document.getElementById('health-status');
            const statusClass = `status-${summary.health_status}`;
            const badgeClass = `badge-${summary.health_status}`;
            
            let issuesHtml = '';
            if (summary.issues && summary.issues.length > 0) {
                issuesHtml = `
                    <div class="mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Issues:</h4>
                        <ul class="space-y-2">
                            ${summary.issues.map(issue => `
                                <li class="flex items-start space-x-2">
                                    <i data-lucide="alert-circle" class="w-4 h-4 text-orange-500 mt-0.5"></i>
                                    <span class="text-sm text-gray-600">${issue}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            healthSection.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="heart-pulse" class="w-6 h-6 ${statusClass}"></i>
                            <h3 class="text-lg font-semibold text-gray-900">System Health</h3>
                        </div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${badgeClass}">
                            ${summary.health_status.toUpperCase()}
                        </span>
                    </div>
                    ${issuesHtml}
                </div>
            `;
        }

        function updateDatabases(databases) {
            const section = document.getElementById('databases-section');
            section.innerHTML = databases.map(db => createDatabaseCard(db)).join('');
        }

        function createDatabaseCard(db) {
            const roleColor = db.role === 'source' ? 'blue' : 'green';
            const roleBadge = db.role === 'source' ? 'Source (Unencrypted)' : 'Target (Encrypted)';
            
            return `
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="server" class="w-6 h-6 text-${roleColor}-600"></i>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">${db.name}</h3>
                                    <p class="text-sm text-gray-500">Current LSN: ${db.current_lsn || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-xs font-medium bg-${roleColor}-100 text-${roleColor}-800">
                                    ${roleBadge}
                                </span>
                                ${db.connected 
                                    ? '<span class="px-3 py-1 rounded-full text-xs font-medium badge-active">Connected</span>'
                                    : '<span class="px-3 py-1 rounded-full text-xs font-medium badge-critical">Disconnected</span>'
                                }
                            </div>
                        </div>
                        ${db.error ? `<div class="mt-3 p-3 bg-red-50 rounded-md"><p class="text-sm text-red-700">${db.error}</p></div>` : ''}
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            ${createReplicationInfo(db)}
                        </div>
                    </div>
                </div>
            `;
        }

        function createReplicationInfo(db) {
            let html = '';

            // Publications (for source)
            if (db.publications && db.publications.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="book-open" class="w-4 h-4 mr-2"></i>
                            Publications
                        </h4>
                        <div class="space-y-3">
                            ${db.publications.map(pub => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${pub.pub_name}</span>
                                        <span class="text-xs text-gray-500">${pub.table_count} tables</span>
                                    </div>
                                    <div class="flex flex-wrap gap-1">
                                        ${pub.pub_insert ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">INSERT</span>' : ''}
                                        ${pub.pub_update ? '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">UPDATE</span>' : ''}
                                        ${pub.pub_delete ? '<span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded">DELETE</span>' : ''}
                                        ${pub.pub_truncate ? '<span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded">TRUNCATE</span>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Replication Slots (for source)
            if (db.replication_slots && db.replication_slots.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="plug" class="w-4 h-4 mr-2"></i>
                            Replication Slots
                        </h4>
                        <div class="space-y-3">
                            ${db.replication_slots.map(slot => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${slot.slot_name}</span>
                                        <span class="px-2 py-0.5 rounded text-xs font-medium ${slot.active ? 'badge-active' : 'badge-inactive'}">
                                            ${slot.active ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div>Confirmed Flush LSN: <span class="font-mono">${slot.confirmed_flush_lsn || 'N/A'}</span></div>
                                        <div>WAL Status: <span class="font-medium">${slot.wal_status || 'N/A'}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Replication Stats (for source)
            if (db.replication_stats && db.replication_stats.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="activity" class="w-4 h-4 mr-2"></i>
                            Replication Statistics
                        </h4>
                        <div class="space-y-3">
                            ${db.replication_stats.map(stat => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${stat.slot_name}</span>
                                        <span class="px-2 py-0.5 rounded text-xs font-medium ${stat.active ? 'badge-active' : 'badge-inactive'}">
                                            ${stat.active ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div>
                                            <span class="text-gray-600">LSN Distance:</span>
                                            <div class="font-semibold ${stat.lsn_distance_bytes > 0 ? 'text-orange-600' : 'text-green-600'}">
                                                ${formatBytes(stat.lsn_distance_bytes)}
                                            </div>
                                        </div>
                                        ${stat.replication_lag_sec !== null ? `
                                            <div>
                                                <span class="text-gray-600">Lag Time:</span>
                                                <div class="font-semibold text-gray-900">${stat.replication_lag_sec.toFixed(2)}s</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        <div>Current: <span class="font-mono">${stat.current_wal_lsn}</span></div>
                                        <div>Flushed: <span class="font-mono">${stat.confirmed_flush_lsn}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Subscriptions (for target)
            if (db.subscriptions && db.subscriptions.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="rss" class="w-4 h-4 mr-2"></i>
                            Subscriptions
                        </h4>
                        <div class="space-y-3">
                            ${db.subscriptions.map(sub => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${sub.sub_name}</span>
                                        <span class="px-2 py-0.5 rounded text-xs font-medium ${sub.enabled ? 'badge-active' : 'badge-inactive'}">
                                            ${sub.enabled ? 'Enabled' : 'Disabled'}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div>Publication: <span class="font-medium">${sub.publication}</span></div>
                                        <div>Slot: <span class="font-mono">${sub.slot_name}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Subscription Stats (for target)
            if (db.subscription_stats && db.subscription_stats.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="bar-chart" class="w-4 h-4 mr-2"></i>
                            Subscription Statistics
                        </h4>
                        <div class="space-y-3">
                            ${db.subscription_stats.map(stat => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="font-medium text-gray-900 mb-2">${stat.sub_name}</div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div>Received LSN: <span class="font-mono">${stat.received_lsn}</span></div>
                                        ${stat.last_msg_receipt_time ? `<div>Last Message: ${new Date(stat.last_msg_receipt_time).toLocaleString()}</div>` : ''}
                                        ${stat.latest_end_lsn ? `<div>Latest End LSN: <span class="font-mono">${stat.latest_end_lsn}</span></div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return html || '<div class="col-span-2 text-center text-gray-500">No replication data available</div>';
        }

        function renderDatabaseTable() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const roleFilter = document.getElementById('filter-role').value;
            const statusFilter = document.getElementById('filter-status').value;
            
            let filtered = allDatabases.filter(db => {
                // Search filter
                if (searchTerm && !db.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Role filter
                if (roleFilter !== 'all' && db.role !== roleFilter) {
                    return false;
                }
                
                // Status filter
                if (statusFilter === 'connected' && !db.connected) return false;
                if (statusFilter === 'disconnected' && db.connected) return false;
                if (statusFilter === 'issues') {
                    const hasIssues = db.error || 
                        (db.replication_stats && db.replication_stats.some(s => !s.active || s.lsn_distance_bytes > 1048576));
                    if (!hasIssues) return false;
                }
                
                return true;
            });
            
            const tbody = document.getElementById('database-table-body');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-8 text-gray-500">
                            No databases match the current filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filtered.map(db => {
                const roleColor = db.role === 'source' ? 'blue' : 'green';
                const statusBadge = db.connected 
                    ? '<span class="px-2 py-0.5 rounded text-xs font-medium badge-active">Connected</span>'
                    : '<span class="px-2 py-0.5 rounded text-xs font-medium badge-critical">Disconnected</span>';
                
                // Get replication info
                let pubSubCount = '-';
                let slotsInfo = '-';
                let lsnDistance = '-';
                let lagSec = '-';
                let details = '';
                
                if (db.role === 'source') {
                    pubSubCount = db.publications ? db.publications.length : 0;
                    
                    if (db.replication_slots && db.replication_slots.length > 0) {
                        const activeSlots = db.replication_slots.filter(s => s.active).length;
                        slotsInfo = `${activeSlots}/${db.replication_slots.length}`;
                    }
                    
                    if (db.replication_stats && db.replication_stats.length > 0) {
                        const maxLag = Math.max(...db.replication_stats.map(s => s.lsn_distance_bytes));
                        lsnDistance = formatBytes(maxLag);
                        
                        const maxLagSec = Math.max(...db.replication_stats.map(s => s.replication_lag_sec || 0));
                        lagSec = maxLagSec > 0 ? maxLagSec.toFixed(2) : '-';
                        
                        details = db.replication_stats.map(s => 
                            `${s.slot_name}: ${formatBytes(s.lsn_distance_bytes)}`
                        ).join(', ');
                    }
                } else {
                    pubSubCount = db.subscriptions ? db.subscriptions.length : 0;
                    
                    if (db.subscriptions && db.subscriptions.length > 0) {
                        const enabledSubs = db.subscriptions.filter(s => s.enabled).length;
                        slotsInfo = `${enabledSubs}/${db.subscriptions.length} enabled`;
                    }
                    
                    if (db.subscription_stats && db.subscription_stats.length > 0) {
                        details = db.subscription_stats.map(s => 
                            `${s.sub_name}: ${s.received_lsn}`
                        ).join(', ');
                    }
                }
                
                const lagClass = lsnDistance !== '-' && lsnDistance !== '0 B' ? 'text-orange-600 font-semibold' : 'text-green-600';
                const isExpanded = expandedRows.has(db.name);
                const expandIcon = isExpanded ? 'chevron-down' : 'chevron-right';
                
                let rows = `
                    <tr onclick="toggleDetail('${db.name}')" class="hover:bg-gray-50">
                        <td class="font-medium text-gray-900">
                            <i data-lucide="${expandIcon}" class="w-4 h-4 inline mr-1"></i>
                            ${db.name}
                        </td>
                        <td><span class="px-2 py-0.5 rounded text-xs font-medium bg-${roleColor}-100 text-${roleColor}-800">${db.role}</span></td>
                        <td>${statusBadge}</td>
                        <td class="font-mono text-xs">${db.current_lsn || '-'}</td>
                        <td class="text-center">${pubSubCount}</td>
                        <td class="text-center text-xs">${slotsInfo}</td>
                        <td class="${lagClass}">${lsnDistance}</td>
                        <td class="text-center">${lagSec}</td>
                        <td class="text-xs text-gray-600 truncate max-w-xs" title="${details}">${details || '-'}</td>
                    </tr>
                `;
                
                // Add detail row if expanded
                if (isExpanded) {
                    rows += `
                        <tr class="detail-row">
                            <td colspan="9" class="detail-content">
                                ${createDetailView(db)}
                            </td>
                        </tr>
                    `;
                }
                
                return rows;
            }).join('');
        }
        
        function toggleDetail(dbName) {
            if (expandedRows.has(dbName)) {
                expandedRows.delete(dbName);
            } else {
                expandedRows.add(dbName);
            }
            renderDatabaseTable();
        }
        
        function createDetailView(db) {
            let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">';
            
            // Publications (for source)
            if (db.publications && db.publications.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="book-open" class="w-4 h-4 mr-2"></i>
                            Publications
                        </h4>
                        <div class="space-y-3">
                            ${db.publications.map(pub => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${pub.pub_name}</span>
                                        <span class="text-xs text-gray-500">${pub.table_count} tables</span>
                                    </div>
                                    <div class="flex flex-wrap gap-1">
                                        ${pub.pub_insert ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">INSERT</span>' : ''}
                                        ${pub.pub_update ? '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">UPDATE</span>' : ''}
                                        ${pub.pub_delete ? '<span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded">DELETE</span>' : ''}
                                        ${pub.pub_truncate ? '<span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-xs rounded">TRUNCATE</span>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Replication Slots (for source)
            if (db.replication_slots && db.replication_slots.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="plug" class="w-4 h-4 mr-2"></i>
                            Replication Slots
                        </h4>
                        <div class="space-y-3">
                            ${db.replication_slots.map(slot => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${slot.slot_name}</span>
                                        <span class="px-2 py-0.5 rounded text-xs font-medium ${slot.active ? 'badge-active' : 'badge-inactive'}">
                                            ${slot.active ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div>Confirmed Flush LSN: <span class="font-mono">${slot.confirmed_flush_lsn || 'N/A'}</span></div>
                                        <div>WAL Status: <span class="font-medium">${slot.wal_status || 'N/A'}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Replication Stats (for source)
            if (db.replication_stats && db.replication_stats.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="activity" class="w-4 h-4 mr-2"></i>
                            Replication Statistics
                        </h4>
                        <div class="space-y-3">
                            ${db.replication_stats.map(stat => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${stat.slot_name}</span>
                                        <span class="px-2 py-0.5 rounded text-xs font-medium ${stat.active ? 'badge-active' : 'badge-inactive'}">
                                            ${stat.active ? 'Active' : 'Inactive'}
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div>
                                            <span class="text-gray-600">LSN Distance:</span>
                                            <div class="font-semibold ${stat.lsn_distance_bytes > 0 ? 'text-orange-600' : 'text-green-600'}">
                                                ${formatBytes(stat.lsn_distance_bytes)}
                                            </div>
                                        </div>
                                        ${stat.replication_lag_sec !== null ? `
                                            <div>
                                                <span class="text-gray-600">Lag Time:</span>
                                                <div class="font-semibold text-gray-900">${stat.replication_lag_sec.toFixed(2)}s</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600">
                                        <div>Current: <span class="font-mono">${stat.current_wal_lsn}</span></div>
                                        <div>Flushed: <span class="font-mono">${stat.confirmed_flush_lsn}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Subscriptions (for target)
            if (db.subscriptions && db.subscriptions.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="rss" class="w-4 h-4 mr-2"></i>
                            Subscriptions
                        </h4>
                        <div class="space-y-3">
                            ${db.subscriptions.map(sub => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-gray-900">${sub.sub_name}</span>
                                        <span class="px-2 py-0.5 rounded text-xs font-medium ${sub.enabled ? 'badge-active' : 'badge-inactive'}">
                                            ${sub.enabled ? 'Enabled' : 'Disabled'}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div>Publication: <span class="font-medium">${sub.publication}</span></div>
                                        <div>Slot: <span class="font-mono">${sub.slot_name}</span></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Subscription Stats (for target)
            if (db.subscription_stats && db.subscription_stats.length > 0) {
                html += `
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="bar-chart" class="w-4 h-4 mr-2"></i>
                            Subscription Statistics
                        </h4>
                        <div class="space-y-3">
                            ${db.subscription_stats.map(stat => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <div class="font-medium text-gray-900 mb-2">${stat.sub_name}</div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div>Received LSN: <span class="font-mono">${stat.received_lsn}</span></div>
                                        ${stat.last_msg_receipt_time ? `<div>Last Message: ${new Date(stat.last_msg_receipt_time).toLocaleString()}</div>` : ''}
                                        ${stat.latest_end_lsn ? `<div>Latest End LSN: <span class="font-mono">${stat.latest_end_lsn}</span></div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // If no data
            if (!db.publications?.length && !db.replication_slots?.length && !db.replication_stats?.length && 
                !db.subscriptions?.length && !db.subscription_stats?.length) {
                html += '<div class="col-span-2 text-center text-gray-500 py-4">No replication data available</div>';
            }
            
            html += '</div>';
            return html;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Event listeners for filters
        document.getElementById('search-box').addEventListener('input', renderDatabaseTable);
        document.getElementById('filter-role').addEventListener('change', renderDatabaseTable);
        document.getElementById('filter-status').addEventListener('change', renderDatabaseTable);

        // Initialize
        connectWebSocket();
        lucide.createIcons();
    </script>
</body>
</html>
